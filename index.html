<html>
<head>
  <title>My first Electron App</title>
  <style>
    holes{
      display: none;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    hole {
      flex-basis: 25%;
      background-image: url(assets/img/hole_t.png);
      background-color: white;
      height: 20vw;
      /*border: 3px solid black;*/
      background-size: cover;
      box-sizing: border-box;
    }
    username{

    }
    username label{

    }
    username input{

    }
    username myname{
      display: none;
    }
    error{
      display: none;
      color: red;
      width: 100%;
      text-align: center;
    }
    dash{
      display: none;
      justify-content: space-between;
      width: 100%;
      align-items: stretch;
    }
    myinfo, scores{
      flex-grow: 1;
      border: 1px solid #ccc;
      display: block;
    }
    myinfo{
      flex-basis: 40%;
    }
    myinfo name{
      font-size: 30px;
      text-transform: capitalize;
      display: block;
      text-align: center;
    }
    myinfo score{
      text-align: center;
    }
    scores{
      flex-basis: 60%;
    }
    scores h2{
      font-weight: normal;
      text-align: center;
    }
    scores h2 span {
      font-style: italic;
    }
    playerlist player{
      display: block;
    }
  </style>
</head>
<body>
  <h1>Gun Moles!</h1>
  <username>
    <label for="username">Please Choose a Username</label>
    <input name="username" id="username" type="text" value="" />
    <button name="submit" id="submit">Let's Go!</button>
  </username>
  <error></error>
  <dash>
    <myinfo>
      <name></name>
      <score>Score: </score>
    </myinfo>
    <scores>
      <h2>Those <span>other</span> guys:</h2>
      <playerlist></playerlist>
    </scores>
  </dash>
  <holes>
    <hole data-id="1"></hole>
    <hole data-id="2"></hole>
    <hole data-id="3"></hole>
    <hole data-id="4"></hole>
    <hole data-id="5"></hole>
    <hole data-id="6"></hole>
    <hole data-id="7"></hole>
  </holes>
</body>
<script>
  const electron = require('electron');
  const { ipcRenderer } = electron;

  var holeElements = document.querySelectorAll('hole');
  var holes = [];
  var i, username;
  var players = [];
  var molesAppeared = {};
  var sessionId = 0;
  var appState = 'enter-user';

  /*==== Hole Listeners ====*/
  for( i = 0; i < holeElements.length; i++){
    holes[i+1] = {
      "elem": holeElements[i],
      "state": "ready"
    };
    holeElements[i].addEventListener('click', function(event){
      clickHole( this.dataset.id );
    });
  }
  /*==== Username Form Listeners ====*/
  document.querySelector('input').onkeypress = (event)=>{
    event = event || window.event;
    if(event.keyCode == 13){
      processUsername( document.querySelector('input').value );
    }
  };
  document.querySelector('button').addEventListener('click',(e)=>{
    processUsername( document.querySelector('input').value );
  });


  /*==== server event handlers ====*/
  ipcRenderer.on('myself:update', (event,data) => {
    // note the sessionId
    sessionId = data.sessionId;
    // set the username
    updateUser( data.sessionId, data.player );
    // show the game if you haven't already
    if( appState == 'enter-user' ){
      showGame();
      appState = 'game';
    }
  });
  ipcRenderer.on('player:update', (event,data) => {
    // update the user
    updateUser( data.sessionId, data.player );
  });
  ipcRenderer.on('holes:update', (event,data) => {
    // If I'm returning to a ready state, clear any mole images.
    if(holes[data.hole].state != data.state && data.state == 'ready'){
      holeState(data.hole,data.state);
    }
    // update the state
    holes[data.hole].state = data.state;
  });
  ipcRenderer.on('mole:update', (event,mole) => {
    // note the mole
    molesAppeared[mole.id] = {
      'createdBy':mole.createdBy,
      'hole':mole.hole,
      'appeared':Date.now(),
      'whacked':false };

    // show the mole to the user
    holeState(mole.hole, 'mole');

    // set the timer to expire the mole
    setTimeout(function(){
      expireMole(mole.hole, mole.id);
    }, 5000);

    // remove old moles
    for( var i in molesAppeared ){
      if( molesAppeared[i].expired ){
        delete molesAppeared[i];
      }
    }
  });

  /*==== page event handlers ====*/

  /*==== helper functions ====*/
  function processUsername( username ){
    if(!username){
      showError('Please enter a username!');
    }else{
      startGame(username);
    }
  }
  function startGame( username ){
    ipcRenderer.send('username:put',{'username':username});
  }
  function updateUser( id, player ){
    players[id] = player; // update the user data
    if( id == sessionId ){ // update my own details
      renderMe();
    }else{
      renderPlayers();  // render the player list
    }
  }
  function showGame(){
    // hide username
    document.querySelector('username').style.display = 'none';
    // show dash
    document.querySelector('dash').style.display = 'flex';
    // show holes
    document.querySelector('holes').style.display = 'flex';
  }
  function clickHole( hId ) {
    console.log('Hole Clicked ', hId);
    console.log('holes', holes);
    var hole = holes[hId];
    if(!hole){ showError("Invalid Hole: " + hId); }
    if( typeof hole.state == 'undefined'){
      console.log('This hole has no state');
      // I don't have a state for the hole. Perhaps go get one?
    }else if( hole.state == 'ready' ){
      console.log('This hole is ready for a mole');
      // Add a new mole!
      ipcRenderer.send("mole:add",{'hId':hId});
    }else if( hole.state == 'mole' ){
      console.log('This hole has a mole already. Let\'s whack it!');
      // whack it!
      whackMole( hId );
    }
  }
  function expireMole( hId, mId ){
    // hide the mole
    holeState(hId,'ready');
    // tag the mole as expired
    if(molesAppeared[mId])
      molesAppeared[mId].expired = true;
    // send a note to the server to expire it
    ipcRenderer.send("mole:expire",{'hId':hId,'mId':mId});
  }
  function showError( error ){
    var errorElem = document.querySelector('error');
    errorElem.innerHTML = 'Error: ' + error;
    errorElem.style.display = 'block';
  }
  function renderMe(){
    document.querySelector('myinfo name').innerHTML = players[sessionId].name;
    document.querySelector('myinfo score').innerHTML = "Score: " + players[sessionId].score;
  }
  function renderPlayers( ){
    const fiveMinutes = 1000 * 60 * 5;
    console.log('render players', players);
    var i=0, html='', p;
    for( i in players ){
      if ( i != '_' && i != sessionId && players[i].lastAction > (Date.now() - fiveMinutes) ) { // Don't render me or players who have been idle for 5 minutes
        p = players[i];
        html += "<player><name>"+p.name+"</name>: <score>"+p.score+"</score>&nbsp;(<sessionId>"+i+"</sessionId>)</player>";
      }
    }
    document.querySelector('scores playerlist').innerHTML = html;
  }
  function holeState( hole, state ){

    if(state == 'mole'){
      holes[hole].elem.style.backgroundImage = "url(assets/img/hole_w_mole.png)";
    }else if (state == 'whacked'){
      holes[hole].elem.style.backgroundImage = "url(assets/img/whacked.png)";
    }else{
      holes[hole].elem.style.backgroundImage = "url(assets/img/hole_t.png)";
    }
  }
  function whackMole( hId ){
    var mId;
    // find my mole
    for(var i in molesAppeared){
      if( molesAppeared[i].hole && molesAppeared[i].hole == hId && !molesAppeared[i].expired ){
        mId = i;
        break;
      }
    }
    if(!mId){
      showError('Umm.. I couldn\'t find a mole in hole '+hId+'...');
    }
    if(!molesAppeared[mId].whacked && molesAppeared[mId].createdBy != sessionId){ // don't whack twice and don't allow me to whack my own mole
      console.log('whacking mole', JSON.stringify(holes[hId]), JSON.stringify(molesAppeared[mId]));
      // show the whacked image
      holeState(hId,'whacked');
      // diff the timeClicked with the time appeared.
    }
  };
</script>
</html>
